# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the **GOV.UK Public Services Status Monitor** - a self-contained status monitoring application that performs periodic HTTP(S) health checks against configured public services and generates static HTML/JSON assets compliant with GOV.UK Design System.

**Current Status**: Specification and planning phase complete. Implementation not yet started.

**License**: MIT License with Crown (GDS) copyright

## Architecture

**Type**: Hybrid Orchestrator Pattern - Single Node.js application with separated concerns:

1. **Node.js Orchestrator** (TypeScript via tsx): Runs health checks using worker threads, writes `_data/health.json`
2. **11ty Static Site Generator**: Invoked as subprocess to generate HTML from templates
3. **Post-build Asset Inlining**: Custom Node.js script inlines all CSS/JS/images as data URIs for self-contained HTML
4. **GitHub Actions Deployment**: Scheduled every 5 minutes, deploys to GitHub Pages

**Key Design Principles**:
- Self-contained HTML (single HTTP request, < 5MB target)
- Meta refresh tag for auto-updates (no JavaScript required)
- CSV-based historical data with GitHub Actions cache fallback
- Worker thread pool (2x CPU cores) for concurrent health checks
- WCAG 2.2 AAA accessibility compliance

## Technology Stack

**Runtime**: Node.js 22+ with TypeScript 5.x (run via `tsx`, no compilation needed)

**Primary Dependencies** (to be installed):
- `@11ty/eleventy` v3+ - Static site generation
- `@x-govuk/govuk-eleventy-plugin` v4+ - GOV.UK Design System integration
- `tsx` - TypeScript execution without compilation
- `js-yaml` - YAML config parsing
- `ajv` - JSON Schema validation
- `uuid` - Correlation ID generation
- `prom-client` - Prometheus metrics
- `pino` - Structured JSON logging

**Testing Stack**:
- `vitest` - Unit testing (fast, native ESM, TypeScript support)
- `playwright` - E2E and accessibility testing (with axe-core for WCAG 2.2 AAA)

## Commands

**Note**: These commands are planned but not yet implemented. Once `package.json` is created:

```bash
# Development
npm run dev              # Run health check orchestrator in watch mode
npx tsx src/index.ts     # Run orchestrator directly

# Testing
npm test                 # Run all test suites (unit, e2e, accessibility, coverage, performance)
npm run test:unit        # Run unit tests only
npm run test:e2e         # Run E2E tests only
npm run test:coverage    # Run with coverage report (80% minimum required)

# Building
npm run build            # Run health checks → 11ty → post-build inlining → output/index.html

# Linting
npm run lint             # ESLint + Prettier
npm run lint:fix         # Auto-fix linting issues
```

## Project Structure

```
/
├── config.yaml                  # Service health check configuration (YAML, fixed path)
├── specs/001-govuk-status-monitor/
│   ├── spec.md                  # Complete feature specification (283 requirements)
│   ├── plan.md                  # Implementation plan (this phase)
│   ├── research.md              # Technology research findings
│   ├── data-model.md            # Core entities and data structures
│   ├── quickstart.md            # Developer setup guide
│   ├── tasks.md                 # Implementation task breakdown
│   └── contracts/               # API contract specifications (OpenAPI)
├── src/                         # Application code (to be created)
│   ├── index.ts                 # Main orchestrator entry point
│   ├── orchestrator/            # Scheduling and worker pool management
│   ├── health-checks/           # HTTP check logic, retry, validation
│   ├── storage/                 # CSV/JSON writers, cache management
│   ├── config/                  # YAML loading, JSON Schema validation
│   ├── metrics/                 # Prometheus metrics
│   ├── logging/                 # Structured logging with correlation IDs
│   ├── inlining/                # Post-build asset inlining scripts
│   └── types/                   # TypeScript type definitions
├── _includes/                   # 11ty templates (Nunjucks)
│   ├── layouts/                 # Base layouts (extend GOV.UK plugin)
│   ├── components/              # Service status components
│   └── macros/                  # Status indicators
├── _data/                       # 11ty data files
│   └── health.json              # Generated by orchestrator (ephemeral)
├── pages/                       # 11ty page templates
│   └── index.njk                # Main status page
├── tests/                       # Test suites (to be created)
│   ├── unit/                    # Vitest unit tests
│   ├── integration/             # Integration tests
│   ├── e2e/                     # Playwright E2E tests (User Stories 1-7)
│   ├── accessibility/           # WCAG 2.2 AAA compliance tests
│   ├── performance/             # Performance benchmarking
│   └── contract/                # API contract validation tests
└── .github/workflows/           # CI/CD workflows (to be created)
    ├── test.yml                 # PR tests
    ├── smoke-test.yml           # Config PR smoke tests
    ├── deploy.yml               # Scheduled deployment (every 5 min)
    └── dependency-update.yml    # Dependabot handling
```

## Configuration

**File**: `config.yaml` (root directory, fixed path)

Defines all monitored services with health check parameters:

```yaml
settings:                         # Optional global defaults
  check_interval: 60              # Default check interval (seconds)
  warning_threshold: 2            # Latency threshold for DEGRADED (seconds)
  timeout: 5                      # HTTP timeout for FAILED (seconds)
  page_refresh: 60                # Browser auto-refresh interval (seconds)
  max_retries: 3                  # Retries for network errors
  worker_pool_size: 0             # 0 = auto (2x CPU cores)

pings:                            # Service definitions (array)
  - name: "Service Name"          # Required (max 100 chars, ASCII)
    protocol: HTTP | HTTPS        # Required
    method: GET | HEAD | POST     # Required
    resource: "https://url"       # Required (full URL)
    tags: ["tag1", "tag2"]        # Optional (lowercase, ASCII, max 100 chars)
    expected:                     # Required (validation criteria)
      status: 200                 # Required (HTTP status code)
      text: "substring"           # Optional (response body substring)
      headers:                    # Optional (expected headers)
        location: "http://..."    # Example: validate redirect
    headers:                      # Optional (custom request headers)
      - name: "Header-Name"
        value: "header value"
    payload: {"key": "value"}     # Optional (POST body, JSON)
    interval: 60                  # Optional (override default)
    warning_threshold: 2          # Optional (override default)
    timeout: 5                    # Optional (override default)
```

**Validation**: Formal JSON Schema validation with detailed error messages (User Story 6)

## Core Data Model

### Service/Ping Entity
Represents a monitored public service with health check configuration.

**Attributes**: name, protocol, method, resource, tags[], expected{status, text, headers}, custom headers[], payload, interval, warning_threshold, timeout, currentStatus, lastCheckTime, lastLatency

### Health Check Result
Outcome of a single monitoring probe.

**Attributes**: serviceName, timestamp, method, status (PASS/DEGRADED/FAIL), latency_ms, httpStatusCode, failureReason, correlationId

**Status States**:
- `PASS`: Response validates successfully, latency within warning threshold
- `DEGRADED`: Response validates but latency exceeds warning_threshold (< timeout)
- `FAIL`: Validation failure or timeout exceeded
- `PENDING`: Configured but not yet checked

### Historical Record (CSV)
Time-series data stored in `history.csv`:

**Columns**: timestamp (ISO 8601), service_name, status, latency_ms, http_status_code, failure_reason, correlation_id

**Storage**: GitHub Actions cache (primary) → GitHub Pages (fallback) → new file (if neither available)

## Key Implementation Details

### Worker Threads
- Pool sized to 2x available CPU cores
- Parallel HTTP health checks using Node.js `worker_threads` module
- Message passing with typed TypeScript interfaces
- Priority queue scheduling by next check time

### Consecutive Failure Threshold
- **HTML Display**: Requires 2 consecutive FAIL statuses (reduces transient noise)
- **CSV/JSON Data**: Single failures recorded (accurate historical tracking)
- **Derivation**: Counted from recent CSV records during HTML generation

### Post-build Asset Inlining
- Custom Node.js script (zero external dependencies)
- Inlines all CSS into `<style>` tags
- Inlines all JavaScript into `<script>` tags
- Base64 encodes images as data URIs
- Target: Self-contained HTML < 5MB

### GitHub Actions Workflows
1. **test.yml**: Run tests on PR (application code or config changes)
2. **smoke-test.yml**: Config-only PR smoke tests with posted comments
3. **deploy.yml**: Scheduled deployment every 5 minutes (health checks → build → deploy)
4. **dependency-update.yml**: Automated Dependabot PR handling

## Constitutional Compliance

This project adheres to strict governance principles in `.specify/memory/constitution.md` (v1.1.1):

### Critical Principles

**I. GDS Design System Compliance (NON-NEGOTIABLE)**
- Use `@x-govuk/govuk-eleventy-plugin` for all UI components
- Extend plugin base layouts, do not create custom layouts
- Follow GOV.UK Design System exactly (buttons, forms, navigation, tags, etc.)
- No Crown logo until hosted on gov.uk domain

**II. Accessibility-First (NON-NEGOTIABLE)**
- WCAG 2.2 Level AAA standard (exceeds typical AA requirement)
- Automated testing: Playwright with axe-core integration
- Manual testing: Keyboard navigation, screen readers (NVDA, JAWS, VoiceOver)
- Enhanced contrast ratios: 7:1 for normal text, 4.5:1 for large text
- Meta refresh tag ensures no JavaScript required for auto-refresh

**III. Test-Driven Development (NON-NEGOTIABLE)**
- Write tests before implementation code
- 80% minimum coverage (branch + line) - enforced in CI
- All test suites run in CI/CD pipeline; failures block merges
- Test categories: unit, integration, e2e, accessibility, performance, contract

**IV. Progressive Enhancement**
- Core functionality works without JavaScript
- Meta refresh tag for auto-updates (no JavaScript polling)
- Static HTML generation (no client-side routing)
- Self-contained HTML works offline after initial load

**V. Performance Budgets (NON-NEGOTIABLE)**
- Page load: < 2 seconds (standard government network)
- Self-contained HTML: < 5MB target
- Single HTTP request architecture
- Performance tests validate benchmarked thresholds

**VI. Component Quality Standards**
- JSON Schema validation for config.yaml
- Security best practices (OWASP Top 10, least-privilege GitHub Actions)
- No secrets in code (use environment variables)
- Structured logging with correlation IDs (UUID v4)

**VII. User Research & Data-Driven Decisions**
- 13 measurable success criteria defined (SC-001 through SC-013)
- 7 user stories with acceptance scenarios
- Prometheus metrics for operational monitoring

**VIII. Research-Driven Technical Decisions (NON-NEGOTIABLE)**
- **Before implementing**, MUST research using:
  - **Context7** (`mcp__context7__resolve-library-id` + `mcp__context7__get-library-docs`): Official library documentation (no token cost - use extensively)
  - **WebSearch**: Best practices, patterns, community consensus (no token cost - use extensively)
  - **WebFetch**: Official docs, changelogs, migration guides (no token cost - use extensively)
  - **Perplexity** (`mcp__perplexity-researcher__perplexity_ask`): Complex architectural decisions (token cost - use judiciously)
- Decision documents (e.g., research.md) MUST cite sources
- Do NOT implement from memory when research tools are available

## Development Workflow

### Phase-based Implementation (per tasks.md)

1. **Phase 1: Setup** - Project structure, package.json, TypeScript/ESLint/Prettier config
2. **Phase 2: Foundational** - Type definitions, JSON Schema, config loader, logger, metrics, Eleventy
3. **Phase 3: User Story 7 (MVP Infrastructure)** - GitHub Actions workflows, deployment pipeline
4. **Phase 4: User Story 1 (MVP)** - Health checks, worker threads, HTML generation, post-build inlining
5. **Phase 5: User Story 2** - Tag display components
6. **Phase 6: User Story 5** - Auto-refresh visibility
7. **Phase 7: User Story 3** - Historical data access (CSV)
8. **Phase 8: User Story 4** - JSON API endpoint
9. **Phase 9: User Story 6** - Configuration validation in CI

### Branching Strategy
- Feature branches: `###-feature-name` from `main`
- Merge via pull requests only
- Commit messages: Conventional Commits (feat:, fix:, docs:, test:, refactor:)
- Protected main branch: Requires passing CI + code review approval

### Code Review Requirements
- All code MUST pass peer review before merge
- Reviewers verify: GDS compliance, accessibility, tests, performance, constitution compliance
- Minimum 2 reviewers for critical paths

## Performance Targets

| Metric | Target | Notes |
|--------|--------|-------|
| Page Load Time | < 2 seconds | Standard government network |
| Health Check Completion | 95% within timeout | Normal conditions |
| Status Update Latency | < 2 minutes | After service failure/recovery |
| HTML File Size | < 5MB | Self-contained with inlined assets |
| Code Coverage | 80% minimum | Both branch and line coverage |
| CPU Pool Size | 2x cores | Health check concurrency |
| Graceful Shutdown | 30 seconds | For in-flight health checks |

## Specification Documents

Located in `specs/001-govuk-status-monitor/`:

- **spec.md** (96KB): 283 functional requirements, 7 user stories, 13 success criteria, 81 edge cases
- **plan.md** (16KB): Implementation project structure, technical context, phase breakdown
- **research.md** (57KB): Technology research, stack justification, best practices
- **data-model.md** (21KB): Entity diagrams, core entity definitions, validation rules, state transitions
- **quickstart.md** (13KB): Prerequisites, installation, configuration, development workflow
- **tasks.md** (30KB): 50+ implementation tasks organized by phase with exact file paths
- **contracts/status-api.openapi.yaml**: OpenAPI 3.0.3 spec for `/api/status.json` endpoint

## Important Notes

1. **No implementation code exists yet** - This is a specification-driven project. All source code in `src/`, `_includes/`, `pages/`, and `tests/` directories needs to be created.

2. **GOV.UK Design System** - Do not deviate from GOV.UK Frontend patterns. Use the official 11ty plugin and extend its base layouts.

3. **Test-Driven Development** - Write tests first, then implement. This is non-negotiable per constitution.

4. **Research Before Implementing** - Use Context7, WebSearch, and WebFetch extensively (no token cost) before writing code. Perplexity for complex architectural decisions only.

5. **Accessibility is Critical** - WCAG 2.2 AAA compliance is mandatory. Test with keyboard navigation and screen readers before code review.

6. **Self-contained HTML** - All CSS/JS/images must be inlined post-build. Monitor file size to stay under 5MB target.

7. **Configuration Validation** - config.yaml uses formal JSON Schema validation. Error messages must be detailed and actionable.

## Getting Help

- **Specification questions**: Review `specs/001-govuk-status-monitor/spec.md` (comprehensive feature specification)
- **Architecture questions**: Review `specs/001-govuk-status-monitor/plan.md` (implementation plan)
- **Technology questions**: Review `specs/001-govuk-status-monitor/research.md` (research findings)
- **Constitution compliance**: Review `.specify/memory/constitution.md` (governance principles)
- **GDS Design System**: Use Context7 to fetch `@x-govuk/govuk-eleventy-plugin` documentation
